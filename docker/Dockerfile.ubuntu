ARG UBUNTU_VERSION=22.04
FROM ubuntu:${UBUNTU_VERSION}

# é¿å…äº’å‹•å¼å®‰è£
ENV DEBIAN_FRONTEND=noninteractive

# å®‰è£å¿…è¦å¥—ä»¶
RUN apt-get update && apt-get install -y \
    cmake \
    build-essential \
    ninja-build \
    pkg-config \
    libgtk-3-dev \
    libgtk-3-0 \
    libglib2.0-dev \
    valgrind \
    xvfb \
    imagemagick \
    dbus-x11 \
    git \
    curl \
    lsb-release \
    && rm -rf /var/lib/apt/lists/*

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /workspace

# è¤‡è£½å°ˆæ¡ˆæª”æ¡ˆ
COPY . /workspace/

# æ¸…ç†ä¸¦å»ºæ§‹å°ˆæ¡ˆ
RUN rm -rf build && \
    mkdir -p build && \
    cd build && \
    cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release && \
    ninja && \
    echo "Build completed successfully"

# è¨­å®šåŸ·è¡Œç’°å¢ƒ
ENV DISPLAY=:99
ENV AUTO_TEST=1

# å»ºç«‹åŸºæœ¬æ¸¬è©¦è…³æœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸ§ª Testing GTK app in Ubuntu $(lsb_release -rs 2>/dev/null || echo unknown) container"\n\
echo "CMake version: $(cmake --version | head -1)"\n\
echo "GTK version: $(pkg-config --modversion gtk+-3.0)"\n\
echo "Ninja version: $(ninja --version)"\n\
\n\
# æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ˜¯å¦å­˜åœ¨\n\
if [ -f /workspace/build/src/gtk-test-app ]; then\n\
    echo "âœ… Application built successfully"\n\
    \n\
    echo "ğŸ–¥ï¸ Starting virtual display..."\n\
    Xvfb :99 -screen 0 1024x768x24 &\n\
    XVFB_PID=$!\n\
    sleep 3\n\
    \n\
    echo "ğŸš€ Running GTK application..."\n\
    cd /workspace/build\n\
    if timeout 15 ./src/gtk-test-app; then\n\
        echo "âœ… Application test passed"\n\
    else\n\
        echo "âš ï¸ Application test completed (timeout expected)"\n\
    fi\n\
    \n\
    # å¯é¸ï¼šæˆªåœ–\n\
    import -window root /tmp/screenshot.png 2>/dev/null && \\\n\
        echo "ğŸ“¸ Screenshot saved" || echo "ğŸ“¸ Screenshot skipped"\n\
    \n\
    # æ¸…ç†\n\
    kill $XVFB_PID 2>/dev/null || true\n\
    \n\
    echo "ğŸ‰ Ubuntu container test successful"\n\
else\n\
    echo "âŒ Application not found at /workspace/build/src/gtk-test-app"\n\
    echo "Build directory contents:"\n\
    ls -la /workspace/build/src/ || echo "build/src directory not found"\n\
    exit 1\n\
fi\n\
' > /workspace/test.sh && chmod +x /workspace/test.sh

# å»ºç«‹è¨˜æ†¶é«”æ¸¬è©¦è…³æœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸ” Running memory leak test in Ubuntu container"\n\
\n\
# æª¢æŸ¥ Valgrind æ˜¯å¦å¯ç”¨\n\
if ! command -v valgrind >/dev/null 2>&1; then\n\
    echo "âŒ Valgrind not found - skipping memory test"\n\
    exit 77\n\
fi\n\
\n\
# æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ˜¯å¦å­˜åœ¨\n\
if [ ! -f /workspace/build/src/gtk-test-app ]; then\n\
    echo "âŒ Application not found"\n\
    exit 1\n\
fi\n\
\n\
# å•Ÿå‹•è™›æ“¬é¡¯ç¤º\n\
echo "ğŸ–¥ï¸ Starting virtual display for memory test..."\n\
export DISPLAY=:99\n\
export AUTO_TEST=1\n\
\n\
Xvfb :99 -screen 0 1024x768x24 &\n\
XVFB_PID=$!\n\
sleep 3\n\
\n\
cd /workspace/build\n\
\n\
echo "ğŸ§ª Running Valgrind memory check..."\n\
valgrind \\\n\
    --tool=memcheck \\\n\
    --leak-check=full \\\n\
    --show-leak-kinds=all \\\n\
    --track-origins=yes \\\n\
    --log-file=/tmp/valgrind.log \\\n\
    timeout 30 ./src/gtk-test-app || true\n\
\n\
echo "ğŸ“Š Memory test results:"\n\
if [ -f /tmp/valgrind.log ]; then\n\
    if grep -q "no leaks are possible" /tmp/valgrind.log; then\n\
        echo "âœ… No memory leaks detected"\n\
    elif grep -q "definitely lost.*0 bytes" /tmp/valgrind.log; then\n\
        echo "âœ… No significant memory leaks"\n\
    else\n\
        echo "âš ï¸ Memory leaks found (expected for test app):"\n\
        grep -A3 "definitely lost\\|possibly lost" /tmp/valgrind.log | head -8 || true\n\
    fi\n\
    echo ""\n\
    grep "ERROR SUMMARY" /tmp/valgrind.log || true\n\
else\n\
    echo "âŒ Valgrind log not found"\n\
fi\n\
\n\
# æ¸…ç†\n\
kill $XVFB_PID 2>/dev/null || true\n\
echo "ğŸ‰ Memory test completed"\n\
' > /workspace/memory-test.sh && chmod +x /workspace/memory-test.sh

# é è¨­åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
CMD ["/workspace/test.sh"]
